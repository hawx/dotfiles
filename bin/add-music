#!/usr/bin/env ruby
# -*- coding: utf-8 -*-
#
# Usage: add-music FILE...
#
#   Adds music to the music library at MUSIC_ROOT using the rules in
#   'music_util.rb'.
#
require_relative 'music_util'
require 'highline/import'

MUSIC_ROOT = Pathname.new(ENV['MUSIC_ROOT'])

def list_songs(songs)
  arr = []
  last_dir = nil
  songs.each do |song|
    this_path = path_for_song(MUSIC_ROOT, song)
    this_dir = File.dirname(this_path)

    if this_dir != last_dir
      arr << [:dir, this_dir, nil]
      last_dir = this_dir
    end

    arr << [:file, this_path, song]
  end
  arr
end

def print_songs(iter)
  iter.each do |k, v, _|
    case k
    when :dir
      puts v
    when :file
      puts "  " + File.basename(v)
    end
  end
end

def add_songs(iter)
  iter.each do |k, v, s|
    case k
    when :dir
      FileUtils.mkdir_p(v)
    when :file
      FileUtils.cp(s, v)
    end
  end
end

if File.identical?(__FILE__, $0)
  songs = list_songs(ARGV)
  print_songs(songs)

  if ask("Add? [yn] ") == "y"
    puts "Adding..."
    add_songs(songs)
  else
    puts "Skipping..."
  end
end
